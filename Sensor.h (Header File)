#ifndef MAX30102_SENSOR_H
#define MAX30102_SENSOR_H

#include <gpiod.h>      
#include <functional>   
#include <thread>       
#include <deque>        
#include <mutex>        
#include <condition_variable>  
#include <atomic>      
#include <vector>       
#include <cstdint>
#include <chrono>       
#include <sys/ioctl.h>  
#include <fcntl.h>      
#include <unistd.h>     

// Default settings / 默认设置
constexpr int DEFAULT_I2C_BUS = 1;              // Default I2C bus / 默认I2C总线
constexpr uint8_t DEFAULT_MAX30102_ADDRESS = 0x57;  // Default sensor address / 默认传感器地址
constexpr int DEFAULT_DRDY_GPIO = 27;           // Default DRDY GPIO pin / 默认DRDY GPIO引脚
constexpr int DEFAULT_DRDY_CHIP = 0;            // Default GPIO chip / 默认GPIO芯片

// Registers (from datasheet) / 寄存器（来自数据手册）
constexpr uint8_t REG_INTR_STATUS_1 = 0x00;
constexpr uint8_t REG_INTR_STATUS_2 = 0x01;
constexpr uint8_t REG_INTR_ENABLE_1 = 0x02;
constexpr uint8_t REG_INTR_ENABLE_2 = 0x03;
constexpr uint8_t REG_FIFO_WR_PTR = 0x04;
constexpr uint8_t REG_OVF_COUNTER = 0x05;
constexpr uint8_t REG_FIFO_RD_PTR = 0x06;
constexpr uint8_t REG_FIFO_DATA = 0x07;
constexpr uint8_t REG_FIFO_CONFIG = 0x08;
constexpr uint8_t REG_MODE_CONFIG = 0x09;
constexpr uint8_t REG_SPO2_CONFIG = 0x0A;
constexpr uint8_t REG_LED1_PA = 0x0C;           // Red LED / 红色LED
constexpr uint8_t REG_LED2_PA = 0x0D;           // IR LED / 红外LED
constexpr uint8_t REG_TEMP_CONFIG = 0x21;
constexpr uint8_t REG_PART_ID = 0xFF;

// FIFO size / FIFO大小
constexpr int FIFO_DEPTH = 32;

// Sample structure (normalized [0,1]) / 样本结构（归一化[0,1]）
struct Sample {
    float red = 0.0f;  // Red channel value / 红色通道值
    float ir = 0.0f;   // IR channel value / 红外通道值
};

class Max30102Sensor {
public:
    // Callback type: called with batch of samples / 回调类型：使用样本批次调用
    using DataCallback = std::function<void(const std::vector<Sample>& samples)>;

    // Constructor with optional interrupt pin / 构造函数，带可选中断引脚
    Max30102Sensor(int interruptPin = DEFAULT_DRDY_GPIO);

    // Destructor for cleanup / 析构函数用于清理
    ~Max30102Sensor();

    // Initialize sensor / 初始化传感器
    bool initialize();

    // Start data acquisition / 开始数据采集
    void start();

    // Stop data acquisition / 停止数据采集
    void stop();

    // Set callback for new data / 设置新数据回调
    void setDataCallback(DataCallback cb);

    // Getter for latest samples (thread-safe) / 获取最新样本（线程安全）
    std::vector<Sample> getLatestSamples(size_t maxCount = 100) const;

private:
    int i2c_fd_ = -1;                       // I2C file descriptor / I2C文件描述符
    int interrupt_pin_;                     // GPIO pin for DRDY / DRDY的GPIO引脚
    mutable std::mutex mutex_;              // Mutex for data access / 数据访问互斥锁
    std::atomic<bool> running_{false};      // Running flag / 运行标志

    // Data buffers (deque for sliding window) / 数据缓冲区（deque用于滑动窗口）
    std::deque<Sample> sample_buffer_;

    DataCallback data_callback_;            // Stored callback / 存储的回调

    std::thread reader_thread_;             // Reader thread / 读取线程

    struct gpiod_chip *chip_ = nullptr;     // GPIO chip / GPIO芯片
    struct gpiod_line *line_irq_ = nullptr; // IRQ line / IRQ线

    // Worker function for thread / 线程的工作函数
    void dataWorker();

    // Read FIFO data / 读取FIFO数据
    void readFifo();

    // Configure sensor registers / 配置传感器寄存器
    bool configureSensor();

    // Write to register / 写入寄存器
    void writeRegister(uint8_t reg, uint8_t value);

    // Read from register / 读取寄存器
    uint8_t readRegister(uint8_t reg);
};

#endif // MAX30102_SENSOR_H
